<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡§µ‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§°‡•á‡§ü‡§æ ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä ‡§´‡•â‡§∞‡•ç‡§Æ (Marunji Dashboard)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap');
        :root {
            --primary-color: #007bff;
            --primary-dark: #0056b3;
            --success-bg: #d4edda;
            --success-text: #155724;
            --error-bg: #f8d7da;
            --error-text: #721c24;
            --light-gray: #f8f9fa;
            --border-color: #cdd3db;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f4f8;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        main {
            display: grid;
            gap: 30px;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }
        @media (min-width: 992px) {
            main { grid-template-columns: 1fr 1fr; }
        }
        @media (max-width: 991px) {
            main { grid-template-columns: 1fr; }
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,37,86,.1);
        }
        h2 {
            text-align: center;
            color: #1a3b5d;
            margin-top: 0;
            margin-bottom: 25px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #334e68;
        }
        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
            transition: border-color .3s, box-shadow .3s;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0,123,255,.1);
        }
        input[readonly] {
            background-color: #e9ecef;
            cursor: not-allowed;
        }
        .total-price {
            font-size: 1.2em;
            font-weight: 600;
            color: #28a745;
            text-align: right;
            margin-top: 10px;
            padding: 10px;
            background-color: var(--light-gray);
            border-radius: 8px;
            border: 1px dashed #28a745;
        }
        button {
            width: 100%;
            padding: 14px;
            margin-top: 10px;
            background: linear-gradient(90deg, var(--primary-color), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform .2s, background .3s;
        }
        button:hover:not(:disabled) {
            transform: scale(1.02);
            filter: brightness(1.1);
        }
        button:disabled {
            background: #a0aec0;
            cursor: not-allowed;
        }
        .message {
            text-align: center;
            margin-top: 20px;
            font-weight: bold;
            font-size: 16px;
            white-space: pre-wrap;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }
        .success {
            color: var(--success-text);
            background-color: var(--success-bg);
            border: 1px solid #c3e6cb;
        }
        .error {
            color: var(--error-text);
            background-color: var(--error-bg);
            border: 1px solid #f5c6cb;
        }
        hr {
            border: none;
            border-top: 1px solid #eee;
            margin: 20px 0;
        }
        #fileNameDisplay {
            margin-top: 8px;
            font-style: italic;
            color: #555;
            display: block;
            font-size: 14px;
        }
        .payment-mode-container {
            display: flex;
            gap: 15px;
            margin-top: 5px;
        }
        .payment-mode-container label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 400;
            cursor: pointer;
        }
        .payment-mode-container input[type="radio"] {
            width: auto;
        }
    </style>
</head>
<body>
    <main>
        <!-- ‡§®‡§µ‡•Ä‡§® ‡§µ‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§®‡•ã‡§Ç‡§¶‡§£‡•Ä ‡§´‡•â‡§∞‡•ç‡§Æ -->
        <div class="container">
            <h2>üè† ‡§®‡§µ‡•Ä‡§® ‡§µ‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§®‡•ã‡§Ç‡§¶‡§µ‡§æ</h2>
            <form id="newSaleForm">
                <input type="hidden" name="action" value="addNewSale">
                
                <div class="form-group">
                    <label for="availableFlats">‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§´‡•ç‡§≤‡•Ö‡§ü:</label>
                    <select id="availableFlats" name="flatId" required>
                        <option value="">‡§≤‡•ã‡§° ‡§π‡•ã‡§§ ‡§Ü‡§π‡•á...</option>
                    </select>
                </div>
                <hr>
                
                <div class="form-group">
                    <label for="buyerName">‡§ñ‡§∞‡•á‡§¶‡•Ä‡§¶‡§æ‡§∞‡§æ‡§ö‡•á ‡§®‡§æ‡§µ:</label>
                    <input type="text" id="buyerName" name="buyerName" placeholder="‡§ñ‡§∞‡•á‡§¶‡•Ä‡§¶‡§æ‡§∞‡§æ‡§ö‡•á ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§®‡§æ‡§µ" required>
                </div>
                
                <div class="form-group">
                    <label for="buyerContact">‡§ñ‡§∞‡•á‡§¶‡•Ä‡§¶‡§æ‡§∞‡§æ‡§ö‡§æ ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï:</label>
                    <input type="tel" id="buyerContact" name="buyerContact" placeholder="‡§Æ‡•ã‡§¨‡§æ‡§à‡§≤ ‡§®‡§Ç‡§¨‡§∞" required>
                </div>
                
                <div class="form-group">
                    <label for="agentName">‡§µ‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§ï‡§∞‡§£‡§æ‡§∞‡•á ‡§è‡§ú‡•á‡§Ç‡§ü‡§ö‡•á ‡§®‡§æ‡§Ç‡§µ:</label>
                    <input type="text" id="agentName" name="agentName" placeholder="‡§è‡§ú‡§Ç‡§ü‡§ö‡•á ‡§®‡§æ‡§µ" required>
                </div>
                
                <div class="form-group">
                    <label for="saleDate">‡§µ‡§ø‡§ï‡•ç‡§∞‡•Ä‡§ö‡•Ä ‡§§‡§æ‡§∞‡•Ä‡§ñ:</label>
                    <input type="date" id="saleDate" name="saleDate" required>
                </div>
                <hr>
                
                <div class="form-group">
                    <label for="basePrice">‡§´‡•ç‡§≤‡•Ö‡§ü‡§ö‡•Ä ‡§Æ‡•Ç‡§≥ ‡§ï‡§ø‡§Ç‡§Æ‡§§ (‚Çπ):</label>
                    <input type="text" id="basePrice" name="basePrice" readonly>
                </div>
                
                <div class="form-group">
                    <label for="finalRate">‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§†‡§∞‡§≤‡•á‡§≤‡•Ä ‡§ï‡§ø‡§Ç‡§Æ‡§§ (‚Çπ):</label>
                    <input type="number" id="finalRate" name="finalRate" placeholder="‡§â‡§¶‡§æ. 2500000" min="1" required>
                </div>
                
                <div class="form-group">
                    <label for="stampDuty">‡§∏‡•ç‡§ü‡•Ö‡§Æ‡•ç‡§™ ‡§°‡•ç‡§Ø‡•Å‡§ü‡•Ä (‚Çπ):</label>
                    <!-- ‡§Ø‡•Å‡§ú‡§∞‡§®‡•á ‡§∏‡•ç‡§µ‡§§‡§É ‡§≠‡§∞‡§≤‡•á‡§≤‡•Ä ‡§ï‡§ø‡§Ç‡§Æ‡§§‡§ö ‡§Ø‡•á‡§•‡•á ‡§ò‡•á‡§§‡§≤‡•Ä ‡§ú‡§æ‡§à‡§≤ -->
                    <input type="number" id="stampDuty" name="stampDuty" placeholder="‡§∏‡•ç‡§µ‡§§‡§É ‡§∞‡§ï‡•ç‡§ï‡§Æ ‡§ü‡§æ‡§ï‡§æ" min="0" required>
                </div>
                
                <div class="form-group">
                    <label for="registryExp">‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä ‡§ö‡§æ‡§∞‡•ç‡§ú‡•á‡§∏ (‚Çπ):</label>
                    <input type="number" class="expense-input" id="registryExp" name="registryExp" value="0" min="0">
                </div>
                
                <div class="form-group">
                    <label for="legalExp">‡§ï‡§æ‡§Ø‡§¶‡•á‡§∂‡•Ä‡§∞ ‡§ñ‡§∞‡•ç‡§ö (‚Çπ):</label>
                    <input type="number" class="expense-input" id="legalExp" name="legalExp" value="0" min="0">
                </div>
                
                <div class="form-group">
                    <label for="bankCharges">‡§¨‡§Å‡§ï ‡§ñ‡§∞‡•ç‡§ö (‚Çπ):</label>
                    <input type="number" class="expense-input" id="bankCharges" name="bankCharges" value="0" min="0">
                </div>
                
                <div class="form-group">
                    <label for="otherExp">‡§á‡§§‡§∞ ‡§ñ‡§∞‡•ç‡§ö (‚Çπ):</label>
                    <input type="number" class="expense-input" id="otherExp" name="otherExp" value="0" min="0">
                </div>
                
                <div class="total-price" id="totalPriceDisplay">‡§è‡§ï‡•Ç‡§£ ‡§µ‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§ï‡§ø‡§Ç‡§Æ‡§§: ‚Çπ0.00</div>
                <hr>
                
                <div class="form-group">
                    <label for="bookingAmount">‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§∞‡§ï‡•ç‡§ï‡§Æ (‚Çπ):</label>
                    <input type="number" id="bookingAmount" name="bookingAmount" placeholder="‡§Ü‡§ú ‡§≠‡§∞‡§≤‡•á‡§≤‡•Ä ‡§∞‡§ï‡•ç‡§ï‡§Æ" min="1" required>
                </div>
                
                <input type="hidden" id="totalPrice" name="totalPrice">
                <button type="submit" id="saleSubmitBtn">‡§µ‡§ø‡§ï‡•ç‡§∞‡•Ä‡§ö‡•Ä ‡§®‡•ã‡§Ç‡§¶ ‡§ï‡§∞‡§æ</button>
            </form>
            <div id="saleMessage" class="message"></div>
        </div>

        <!-- ‡§π‡§™‡•ç‡§§‡§æ ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡§£‡•ç‡§Ø‡§æ‡§ö‡§æ ‡§´‡•â‡§∞‡•ç‡§Æ -->
        <div class="container">
            <h2>üí∞ ‡§π‡§™‡•ç‡§§‡§æ ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡§æ</h2>
            <form id="installmentForm">
                <input type="hidden" name="action" value="addInstallment">
                
                <div class="form-group">
                    <label for="soldFlats">‡§µ‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§ù‡§æ‡§≤‡•á‡§≤‡•á ‡§´‡•ç‡§≤‡•Ö‡§ü:</label>
                    <select id="soldFlats" name="flatId" required>
                        <option value="">‡§≤‡•ã‡§° ‡§π‡•ã‡§§ ‡§Ü‡§π‡•á...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="paymentDate">‡§™‡•á‡§Æ‡•á‡§Ç‡§ü‡§ö‡•Ä ‡§§‡§æ‡§∞‡•Ä‡§ñ:</label>
                    <input type="date" id="paymentDate" name="paymentDate" required>
                </div>
                
                <div class="form-group">
                    <label for="paymentAmount">‡§π‡§™‡•ç‡§§‡•ç‡§Ø‡§æ‡§ö‡•Ä ‡§∞‡§ï‡•ç‡§ï‡§Æ (‚Çπ):</label>
                    <input type="number" id="paymentAmount" name="paymentAmount" placeholder="‡§∞‡§ï‡•ç‡§ï‡§Æ ‡§ü‡§æ‡§ï‡§æ" min="1" required>
                </div>
                
                <div class="form-group">
                    <label>‡§™‡•á‡§Æ‡•á‡§Ç‡§ü‡§ö‡§æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ (Payment Mode):</label>
                    <div class="payment-mode-container">
                        <label><input type="radio" name="paymentMode" value="Online" checked> ‡§ë‡§®‡§≤‡§æ‡§à‡§®</label>
                        <label><input type="radio" name="paymentMode" value="Cash"> ‡§∞‡•ã‡§ñ (Cash)</label>
                        <label><input type="radio" name="paymentMode" value="Cheque"> ‡§ö‡•á‡§ï (Cheque)</label>
                    </div>
                </div>
                
                <div class="form-group">
                   <label for="screenshotFile">‡§™‡§æ‡§µ‡§§‡•Ä/‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§®‡§∂‡•â‡§ü ‡§Ö‡§™‡§≤‡•ã‡§° (‡§ê‡§ö‡•ç‡§õ‡§ø‡§ï):</label>
                   <input type="file" id="screenshotFile" name="screenshotFile" accept="image/*">
                   <span id="fileNameDisplay"></span>
                </div>
                
                <div class="form-group">
                    <label for="notes">‡§ü‡•Ä‡§™ (‡§ï‡§æ‡§π‡•Ä ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§Ö‡§∏‡§≤‡•ç‡§Ø‡§æ‡§∏):</label>
                    <input type="text" id="notes" name="notes" placeholder="‡§â‡§¶‡§æ. ‡§¶‡•Å‡§∏‡§∞‡§æ ‡§π‡§™‡•ç‡§§‡§æ, ‡§ö‡•á‡§ï ‡§®‡§Ç‡§¨‡§∞ ‡§á.">
                </div>
                
                <button type="submit" id="installmentSubmitBtn">‡§π‡§™‡•ç‡§§‡§æ ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡§æ</button>
            </form>
            <div id="installmentMessage" class="message"></div>
        </div>
    </main>
    
    <script>
        // ‚ñº‚ñº‚ñº ‡§§‡•Å‡§Æ‡§ö‡•Ä Google Apps Script URL ‡§á‡§•‡•á ‡§ü‡§æ‡§ï‡§æ ‚ñº‚ñº‚ñº
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwy-U0_ab-Uwj_NiTBChCebqaWJ_A0sfKuvtCUhf4hj236QF7IvhbUoHdAPDDfziXM/exec'; 

        const availableFlatsSelect = document.getElementById('availableFlats');
        const soldFlatsSelect = document.getElementById('soldFlats');
        const newSaleForm = document.getElementById('newSaleForm');
        const installmentForm = document.getElementById('installmentForm');
        const basePriceInput = document.getElementById('basePrice');
        const finalRateInput = document.getElementById('finalRate');
        const stampDutyInput = document.getElementById('stampDuty');
        const totalPriceDisplay = document.getElementById('totalPriceDisplay');
        const expenseInputs = document.querySelectorAll('.expense-input');
        const screenshotFileInput = document.getElementById('screenshotFile');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        
        let availableFlatsData = [];
        
        const formatCurrency = (num) => `‚Çπ${Number(num).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

        // *‡§Æ‡§π‡§§‡•ç‡§µ‡§æ‡§ö‡•á*: ‡§∏‡•ç‡§ü‡•Ö‡§Æ‡•ç‡§™ ‡§°‡•ç‡§Ø‡•Å‡§ü‡•Ä ‡§Æ‡•Ö‡§®‡•ç‡§Ø‡•Å‡§Ö‡§≤‡•Ä ‡§á‡§®‡§™‡•Å‡§ü ‡§Æ‡§ß‡•Ç‡§® ‡§ò‡•á‡§ä‡§® ‡§è‡§ï‡•Ç‡§£ ‡§¨‡•á‡§∞‡•Ä‡§ú ‡§ï‡§∞‡§£‡•á
        function calculateTotal() {
            const finalRate = parseFloat(finalRateInput.value) || 0;
            const stampDuty = parseFloat(stampDutyInput.value) || 0; // ‡§´‡§ï‡•ç‡§§ ‡§Æ‡•Ö‡§®‡•ç‡§Ø‡•Å‡§Ö‡§≤ ‡§µ‡•ç‡§π‡•Ö‡§≤‡•ç‡§Ø‡•Ç ‡§ò‡•á‡§£‡§æ‡§∞
            
            let otherExpenses = 0;
            expenseInputs.forEach(input => {
                otherExpenses += parseFloat(input.value) || 0;
            });
            
            const total = finalRate + stampDuty + otherExpenses;
            totalPriceDisplay.textContent = `‡§è‡§ï‡•Ç‡§£ ‡§µ‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§ï‡§ø‡§Ç‡§Æ‡§§: ${formatCurrency(total)}`;
            document.getElementById('totalPrice').value = total;
        }
        
        async function fetchInitialData() {
            try {
                const response = await fetch(WEB_APP_URL);
                const data = await response.json();
                if (data.status === 'success') {
                    availableFlatsData = data.availableFlats;
                    availableFlatsSelect.innerHTML = '<option value="">-- ‡§®‡§ø‡§µ‡§°‡§æ --</option>';
                    data.availableFlats.forEach(flat => {
                        availableFlatsSelect.add(new Option(`${flat.flatId} - (${formatCurrency(flat.price)})`, flat.flatId));
                    });
                    soldFlatsSelect.innerHTML = '<option value="">-- ‡§®‡§ø‡§µ‡§°‡§æ --</option>';
                    data.soldFlats.forEach(flat => {
                        soldFlatsSelect.add(new Option(flat, flat));
                    });
                }
            } catch (error) {
                console.error("Error:", error);
                alert("‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§§‡§æ‡§®‡§æ ‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä ‡§Ü‡§≤‡•Ä.");
            }
        }
        
        function getBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        async function handleFormSubmit(event, form, submitBtn, messageDiv) {
            event.preventDefault();
            submitBtn.disabled = true;
            const originalBtnText = submitBtn.textContent;
            submitBtn.textContent = '‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§∏‡•Å‡§∞‡•Ç ‡§Ü‡§π‡•á...';
            messageDiv.style.display = 'none';
            
            const formData = new FormData(form);
            let payload = Object.fromEntries(formData.entries());

            if (form.id === 'installmentForm' && screenshotFileInput.files.length > 0) {
                const file = screenshotFileInput.files[0];
                try {
                    payload.fileData = await getBase64(file);
                    payload.mimeType = file.type;
                    payload.fileName = file.name;
                } catch(e) { console.error(e); }
            }

            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const resultText = await response.text();
                
                if (resultText.includes('‡§Ø‡§∂‡§∏‡•ç‡§µ‡•Ä‡§∞‡§ø‡§§‡•ç‡§Ø‡§æ')) {
                    messageDiv.textContent = "‚úÖ " + resultText;
                    messageDiv.className = 'message success';
                    form.reset();
                    // ‡§∞‡§ø‡§∏‡•á‡§ü ‡§®‡§Ç‡§§‡§∞ ‡§ï‡§æ‡§π‡•Ä ‡§°‡•Ä‡§´‡•â‡§≤‡•ç‡§ü ‡§µ‡•ç‡§π‡•Ö‡§≤‡•ç‡§Ø‡•Ç‡§ú
                    if(form.id === 'newSaleForm') {
                        calculateTotal();
                    }
                    fileNameDisplay.textContent = "";
                    fetchInitialData();
                } else {
                    throw new Error(resultText);
                }
            } catch (error) {
                messageDiv.textContent = "‚ùå ‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä: " + error.message;
                messageDiv.className = 'message error';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalBtnText;
                messageDiv.style.display = 'block';
                window.scrollTo({ top: messageDiv.offsetTop - 100, behavior: 'smooth' });
            }
        }

        function init() {
            document.getElementById('saleDate').valueAsDate = new Date();
            document.getElementById('paymentDate').valueAsDate = new Date();
            
            availableFlatsSelect.addEventListener('change', () => {
                const flat = availableFlatsData.find(f => f.flatId === availableFlatsSelect.value);
                if (flat) {
                    basePriceInput.value = flat.price;
                    finalRateInput.value = flat.price;
                    calculateTotal();
                }
            });

            // ‡§∏‡§∞‡•ç‡§µ ‡§á‡§®‡§™‡•Å‡§ü‡§≤‡§æ ‡§á‡§µ‡•ç‡§π‡•á‡§Ç‡§ü ‡§≤‡§æ‡§µ‡§≤‡•á ‡§ú‡•á‡§£‡•á‡§ï‡§∞‡•Ç‡§® ‡§ü‡§æ‡§á‡§™ ‡§ï‡§∞‡§§‡§æ‡§®‡§æ ‡§≤‡§ó‡•á‡§ö ‡§ü‡•ã‡§ü‡§≤ ‡§¨‡§¶‡§≤‡•á‡§≤
            finalRateInput.addEventListener('input', calculateTotal);
            stampDutyInput.addEventListener('input', calculateTotal);
            expenseInputs.forEach(input => input.addEventListener('input', calculateTotal));
            
            screenshotFileInput.addEventListener('change', () => {
                fileNameDisplay.textContent = screenshotFileInput.files[0] ? `‡§®‡§ø‡§µ‡§°‡§≤‡•á‡§≤‡•Ä ‡§´‡§æ‡§á‡§≤: ${screenshotFileInput.files[0].name}` : "";
            });

            newSaleForm.addEventListener('submit', (e) => handleFormSubmit(e, newSaleForm, document.getElementById('saleSubmitBtn'), document.getElementById('saleMessage')));
            installmentForm.addEventListener('submit', (e) => handleFormSubmit(e, installmentForm, document.getElementById('installmentSubmitBtn'), document.getElementById('installmentMessage')));
            
            fetchInitialData();
            calculateTotal();
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

