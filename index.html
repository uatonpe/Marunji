<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡§µ‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§°‡•á‡§ü‡§æ ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä ‡§´‡•â‡§∞‡•ç‡§Æ (Marunji Dashboard)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap');
        :root{--primary-color:#007bff;--primary-dark:#0056b3;--success-bg:#d4edda;--success-text:#155724;--error-bg:#f8d7da;--error-text:#721c24;--light-gray:#f8f9fa;--border-color:#cdd3db}
        body{font-family:'Poppins',sans-serif;background-color:#f0f4f8;margin:0;padding:20px;box-sizing:border-box}
        main{display:grid;gap:30px;width:100%;max-width:1200px;margin:0 auto}
        @media (min-width:992px){main{grid-template-columns:1fr 1fr}}
        @media (max-width:991px){main{grid-template-columns:1fr}}
        .container{background-color:white;padding:30px;border-radius:12px;box-shadow:0 8px 24px rgba(0,37,86,.1)}
        h2{text-align:center;color:#1a3b5d;margin-top:0;margin-bottom:25px;border-bottom:2px solid var(--primary-color);padding-bottom:10px}
        .form-group{margin-bottom:15px}
        label{display:block;margin-bottom:8px;font-weight:500;color:#334e68}
        input,select{width:100%;padding:12px;border:1px solid var(--border-color);border-radius:8px;box-sizing:border-box;font-size:16px;transition:border-color .3s,box-shadow .3s}
        input:focus,select:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(0,123,255,.1)}
        input[readonly]{background-color:#e9ecef;cursor:not-allowed}
        .total-price{font-size:1.2em;font-weight:600;color:#28a745;text-align:right;margin-top:10px;padding:10px;background-color:var(--light-gray);border-radius:8px}
        button{width:100%;padding:14px;margin-top:10px;background:linear-gradient(90deg,var(--primary-color),var(--primary-dark));color:white;border:none;border-radius:8px;font-size:18px;font-weight:600;cursor:pointer;transition:transform .2s,background .3s}
        button:hover:not(:disabled){transform:scale(1.02)}
        button:disabled{background:#a0aec0;cursor:not-allowed}
        .message{text-align:center;margin-top:20px;font-weight:bold;font-size:16px;white-space:pre-wrap;padding:15px;border-radius:8px;display:none}
        .success{color:var(--success-text);background-color:var(--success-bg);border:1px solid #c3e6cb}
        .error{color:var(--error-text);background-color:var(--error-bg);border:1px solid #f5c6cb}
        hr{border:none;border-top:1px solid #eee;margin:20px 0}
        #fileNameDisplay{margin-top:8px;font-style:italic;color:#555;display:block;}
    </style>
</head>
<body>
    <main>
        <!-- ‡§®‡§µ‡•Ä‡§® ‡§µ‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§®‡•ã‡§Ç‡§¶‡§£‡•Ä ‡§´‡•â‡§∞‡•ç‡§Æ ( ‡§Ø‡§æ‡§§ ‡§¨‡§¶‡§≤ ‡§®‡§æ‡§π‡•Ä ) -->
        <div class="container">
            <h2>üè† ‡§®‡§µ‡•Ä‡§® ‡§µ‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§®‡•ã‡§Ç‡§¶‡§µ‡§æ</h2>
            <form id="newSaleForm">
                <input type="hidden" name="action" value="addNewSale">
                <div class="form-group"><label for="availableFlats">‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§´‡•ç‡§≤‡•Ö‡§ü:</label><select id="availableFlats" name="flatId" required><option value="">‡§≤‡•ã‡§° ‡§π‡•ã‡§§ ‡§Ü‡§π‡•á...</option></select></div><hr>
                <div class="form-group"><label for="buyerName">‡§ñ‡§∞‡•á‡§¶‡•Ä‡§¶‡§æ‡§∞‡§æ‡§ö‡•á ‡§®‡§æ‡§µ:</label><input type="text" id="buyerName" name="buyerName" required></div>
                <div class="form-group"><label for="buyerContact">‡§ñ‡§∞‡•á‡§¶‡•Ä‡§¶‡§æ‡§∞‡§æ‡§ö‡§æ ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï:</label><input type="tel" id="buyerContact" name="buyerContact" required></div>
                <div class="form-group"><label for="agentName">‡§µ‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§ï‡§∞‡§£‡§æ‡§∞‡•á ‡§è‡§ú‡•á‡§Ç‡§ü‡§ö‡•á ‡§®‡§æ‡§Ç‡§µ:</label><input type="text" id="agentName" name="agentName" required></div>
                <div class="form-group"><label for="saleDate">‡§µ‡§ø‡§ï‡•ç‡§∞‡•Ä‡§ö‡•Ä ‡§§‡§æ‡§∞‡•Ä‡§ñ:</label><input type="date" id="saleDate" name="saleDate" required></div><hr>
                <div class="form-group"><label for="basePrice">‡§´‡•ç‡§≤‡•Ö‡§ü‡§ö‡•Ä ‡§Æ‡•Ç‡§≥ ‡§ï‡§ø‡§Ç‡§Æ‡§§ (‚Çπ):</label><input type="text" id="basePrice" name="basePrice" readonly></div>
                <div class="form-group"><label for="finalRate">‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§ï‡§ø‡§Ç‡§Æ‡§§ (‚Çπ):</label><input type="number" id="finalRate" name="finalRate" min="1" required></div>
                <div class="form-group"><label for="registryExp">‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä ‡§ö‡§æ‡§∞‡•ç‡§ú‡•á‡§∏ (‚Çπ):</label><input type="number" class="expense" id="registryExp" name="registryExp" value="200000" min="0"></div>
                <div class="form-group"><label for="stampDuty">‡§∏‡•ç‡§ü‡•Ö‡§Æ‡•ç‡§™ ‡§°‡•ç‡§Ø‡•Å‡§ü‡•Ä (8%) (‚Çπ):</label><input type="number" id="stampDuty" name="stampDuty" readonly></div>
                <div class="form-group"><label for="legalExp">‡§ï‡§æ‡§Ø‡§¶‡•á‡§∂‡•Ä‡§∞ ‡§ñ‡§∞‡•ç‡§ö (‚Çπ):</label><input type="number" class="expense" id="legalExp" name="legalExp" value="0" min="0"></div>
                <div class="form-group"><label for="bankCharges">‡§¨‡§Å‡§ï ‡§ñ‡§∞‡•ç‡§ö (‚Çπ):</label><input type="number" class="expense" id="bankCharges" name="bankCharges" value="0" min="0"></div>
                <div class="form-group"><label for="otherExp">‡§á‡§§‡§∞ ‡§ñ‡§∞‡•ç‡§ö (‚Çπ):</label><input type="number" class="expense" id="otherExp" name="otherExp" value="0" min="0"></div>
                <div class="total-price" id="totalPriceDisplay">‡§è‡§ï‡•Ç‡§£ ‡§ï‡§ø‡§Ç‡§Æ‡§§: ‚Çπ0.00</div><hr>
                <div class="form-group"><label for="bookingAmount">‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§∞‡§ï‡•ç‡§ï‡§Æ (‚Çπ):</label><input type="number" id="bookingAmount" name="bookingAmount" min="1" required></div>
                <input type="hidden" id="totalPrice" name="totalPrice"><button type="submit" id="saleSubmitBtn">‡§µ‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§®‡•ã‡§Ç‡§¶‡§µ‡§æ</button>
            </form>
            <div id="saleMessage" class="message"></div>
        </div>

        <!-- ‡§π‡§™‡•ç‡§§‡§æ ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡§£‡•ç‡§Ø‡§æ‡§ö‡§æ ‡§´‡•â‡§∞‡•ç‡§Æ ( ‡§Ø‡§æ‡§§ ‡§¨‡§¶‡§≤ ‡§ï‡•á‡§≤‡•á ‡§Ü‡§π‡•á‡§§ ) -->
        <div class="container">
            <h2>üí∞ ‡§π‡§™‡•ç‡§§‡§æ ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡§æ</h2>
            <form id="installmentForm">
                <input type="hidden" name="action" value="addInstallment">
                <div class="form-group"><label for="soldFlats">‡§µ‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§ù‡§æ‡§≤‡•á‡§≤‡•á ‡§´‡•ç‡§≤‡•Ö‡§ü:</label><select id="soldFlats" name="flatId" required><option value="">‡§≤‡•ã‡§° ‡§π‡•ã‡§§ ‡§Ü‡§π‡•á...</option></select></div>
                <div class="form-group"><label for="paymentDate">‡§™‡•á‡§Æ‡•á‡§Ç‡§ü‡§ö‡•Ä ‡§§‡§æ‡§∞‡•Ä‡§ñ:</label><input type="date" id="paymentDate" name="paymentDate" required></div>
                <div class="form-group"><label for="paymentAmount">‡§π‡§™‡•ç‡§§‡•ç‡§Ø‡§æ‡§ö‡•Ä ‡§∞‡§ï‡•ç‡§ï‡§Æ (‚Çπ):</label><input type="number" id="paymentAmount" name="paymentAmount" min="1" required></div>
                
                <!-- ‚ñº‚ñº‚ñº ‡§®‡§µ‡•Ä‡§® ‡§´‡§æ‡§á‡§≤ ‡§Ö‡§™‡§≤‡•ã‡§° ‡§´‡•Ä‡§≤‡•ç‡§° ‚ñº‚ñº‚ñº -->
                <div class="form-group">
                   <label for="screenshotFile">‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§®‡§∂‡•â‡§ü ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡§æ (‡§ê‡§ö‡•ç‡§õ‡§ø‡§ï):</label>
                   <input type="file" id="screenshotFile" name="screenshotFile" accept="image/*">
                   <span id="fileNameDisplay"></span>
                </div>
                <!-- ‚ñ≤‚ñ≤‚ñ≤ ‡§®‡§µ‡•Ä‡§® ‡§´‡§æ‡§á‡§≤ ‡§Ö‡§™‡§≤‡•ã‡§° ‡§´‡•Ä‡§≤‡•ç‡§° ‚ñ≤‚ñ≤‚ñ≤ -->
                
                <div class="form-group"><label for="notes">‡§ü‡•Ä‡§™ (‡§ê‡§ö‡•ç‡§õ‡§ø‡§ï):</label><input type="text" id="notes" name="notes"></div>
                <button type="submit" id="installmentSubmitBtn">‡§π‡§™‡•ç‡§§‡§æ ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡§æ</button>
            </form>
            <div id="installmentMessage" class="message"></div>
        </div>
    </main>
    
    <script>
        // ‚ñº‚ñº‚ñº ‡§§‡•Å‡§Æ‡§ö‡§æ ‡§§‡•à‡§®‡§æ‡§§ ‡§ï‡•á‡§≤‡•á‡§≤‡§æ ‡§µ‡•á‡§¨ ‡•≤‡§™ URL ‡§á‡§•‡•á ‡§™‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡§æ ‚ñº‚ñº‚ñº
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzryb0o_HPvyyOO6LRa8jjnXJayLdu6Xz5kblfG0tQ3oHKCJVERGFzvcmVychRAhVk/exec'; // <-- ‡§§‡•Å‡§Æ‡§ö‡•Ä ‡§®‡§µ‡•Ä‡§® URL ‡§á‡§•‡•á ‡§ü‡§æ‡§ï‡§æ

        // --- Element Selectors ---
        const availableFlatsSelect = document.getElementById('availableFlats');
        const soldFlatsSelect = document.getElementById('soldFlats');
        const newSaleForm = document.getElementById('newSaleForm');
        const installmentForm = document.getElementById('installmentForm');
        const basePriceInput = document.getElementById('basePrice');
        const finalRateInput = document.getElementById('finalRate');
        const stampDutyInput = document.getElementById('stampDuty');
        const registryExpInput = document.getElementById('registryExp');
        const totalPriceDisplay = document.getElementById('totalPriceDisplay');
        const expenseInputs = document.querySelectorAll('.expense');
        const screenshotFileInput = document.getElementById('screenshotFile');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        let availableFlatsData = [];
        
        const formatCurrency = (num) => `‚Çπ${Number(num).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

        function updateTotalPrice() {
            const finalRate = parseFloat(finalRateInput.value) || 0;
            const stampDutyValue = finalRate * 0.08;
            stampDutyInput.value = stampDutyValue.toFixed(2);
            const registryExp = parseFloat(registryExpInput.value) || 0;
            const legalExp = parseFloat(document.getElementById('legalExp').value) || 0;
            const bankCharges = parseFloat(document.getElementById('bankCharges').value) || 0;
            const otherExp = parseFloat(document.getElementById('otherExp').value) || 0;
            const total = finalRate + registryExp + stampDutyValue + legalExp + bankCharges + otherExp;
            totalPriceDisplay.textContent = `‡§è‡§ï‡•Ç‡§£ ‡§ï‡§ø‡§Ç‡§Æ‡§§: ${formatCurrency(total)}`;
            document.getElementById('totalPrice').value = total;
        }
        
        async function fetchAndPopulateForms() {
            try {
                const response = await fetch(WEB_APP_URL);
                if (!response.ok) throw new Error('Network response was not ok.');
                const data = await response.json();
                if (data.status === 'success') {
                    availableFlatsData = data.availableFlats;
                    availableFlatsSelect.innerHTML = '<option value="">-- ‡§´‡•ç‡§≤‡•Ö‡§ü ‡§®‡§ø‡§µ‡§°‡§æ --</option>';
                    data.availableFlats.forEach(flat => availableFlatsSelect.add(new Option(`${flat.flatId} - (${formatCurrency(flat.price)})`, flat.flatId)));
                    soldFlatsSelect.innerHTML = '<option value="">-- ‡§´‡•ç‡§≤‡•Ö‡§ü ‡§®‡§ø‡§µ‡§°‡§æ --</option>';
                    data.soldFlats.forEach(flatInfo => soldFlatsSelect.add(new Option(flatInfo, flatInfo)));
                } else { throw new Error(data.message); }
            } catch (error) {
                console.error("Error loading flats:", error);
                availableFlatsSelect.innerHTML = `<option value="">‡§è‡§∞‡§∞!</option>`;
                soldFlatsSelect.innerHTML = `<option value="">‡§è‡§∞‡§∞!</option>`;
            }
        }
        
        // ‡§´‡§æ‡§á‡§≤‡§≤‡§æ Base64 ‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§∞‡•Ç‡§™‡§æ‡§Ç‡§§‡§∞‡§ø‡§§ ‡§ï‡§∞‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä ‡§´‡§Ç‡§ï‡•ç‡§∂‡§®
        function getBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    // "data:image/jpeg;base64," ‡§π‡§æ ‡§≠‡§æ‡§ó ‡§ï‡§æ‡§¢‡•Ç‡§® ‡§ü‡§æ‡§ï‡§§‡•ã
                    const base64Data = reader.result.split(',')[1];
                    resolve(base64Data);
                };
                reader.onerror = error => reject(error);
            });
        }

        async function handleFormSubmit(event, form, submitBtn, messageDiv) {
            event.preventDefault();
            submitBtn.disabled = true;
            submitBtn.textContent = '‡§™‡§æ‡§†‡§µ‡§§ ‡§Ü‡§π‡•á...';
            messageDiv.style.display = 'none';
            
            // ‡§´‡•â‡§∞‡•ç‡§Æ‡§Æ‡§ß‡•Ä‡§≤ ‡§∏‡§∞‡•ç‡§µ ‡§´‡•Ä‡§≤‡•ç‡§°‡•ç‡§∏‡§ö‡•á JSON ‡§ë‡§¨‡•ç‡§ú‡•á‡§ï‡•ç‡§ü ‡§¨‡§®‡§µ‡§§‡•ã
            const formData = new FormData(form);
            let payload = Object.fromEntries(formData.entries());

            // ‡§ú‡§∞ ‡§π‡§™‡•ç‡§§‡§æ ‡§´‡•â‡§∞‡•ç‡§Æ ‡§Ö‡§∏‡•á‡§≤ ‡§Ü‡§£‡§ø ‡§´‡§æ‡§á‡§≤ ‡§®‡§ø‡§µ‡§°‡§≤‡•Ä ‡§Ö‡§∏‡•á‡§≤, ‡§§‡§∞ ‡§§‡•Ä ‡§™‡•ç‡§∞‡•ã‡§∏‡•á‡§∏ ‡§ï‡§∞‡§æ
            if (form.id === 'installmentForm' && screenshotFileInput.files.length > 0) {
                const file = screenshotFileInput.files[0];
                submitBtn.textContent = '‡§´‡§æ‡§á‡§≤ ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡§§ ‡§Ü‡§π‡•á...';
                try {
                    const base64File = await getBase64(file);
                    payload.fileData = base64File;
                    payload.mimeType = file.type;
                    payload.fileName = file.name;
                } catch(e) {
                    messageDiv.textContent = '‡§´‡§æ‡§á‡§≤ ‡§µ‡§æ‡§ö‡§§‡§æ‡§®‡§æ ‡§è‡§∞‡§∞ ‡§Ü‡§≤‡§æ.';
                    messageDiv.className = 'message error';
                    messageDiv.style.display = 'block';
                    submitBtn.disabled = false;
                    submitBtn.textContent = '‡§π‡§™‡•ç‡§§‡§æ ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡§æ';
                    return; // ‡§è‡§∞‡§∞ ‡§Ü‡§≤‡•ç‡§Ø‡§æ‡§∏ ‡§•‡§æ‡§Ç‡§¨‡§µ‡§æ
                }
            }

            try {
                submitBtn.textContent = '‡§°‡•á‡§ü‡§æ ‡§™‡§æ‡§†‡§µ‡§§ ‡§Ü‡§π‡•á...';
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, // Apps Script ‡§≤‡§æ JSON ‡§∏‡§Æ‡§ú‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä ‡§π‡•á ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§Ü‡§π‡•á
                    body: JSON.stringify(payload)
                });
                const resultText = await response.text();
                if (!response.ok || !resultText.includes('‡§Ø‡§∂‡§∏‡•ç‡§µ‡•Ä‡§∞‡§ø‡§§‡•ç‡§Ø‡§æ')) {
                    throw new Error(resultText);
                }

                messageDiv.textContent = resultText;
                messageDiv.className = 'message success';
                
                form.reset();
                if (form.id === 'newSaleForm') {
                    registryExpInput.value = '200000';
                    updateTotalPrice();
                } else {
                    fileNameDisplay.textContent = ''; // ‡§´‡§æ‡§á‡§≤‡§ö‡•á ‡§®‡§æ‡§µ ‡§ï‡•ç‡§≤‡§ø‡§Ø‡§∞ ‡§ï‡§∞‡§æ
                }
                form.querySelector('input[type="date"]').valueAsDate = new Date();
                fetchAndPopulateForms();
            } catch (error) {
                messageDiv.textContent = error.message.replace(/<[^>]*>?/gm, '').replace('‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä: ', '');
                messageDiv.className = 'message error';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = form.id === 'newSaleForm' ? '‡§µ‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§®‡•ã‡§Ç‡§¶‡§µ‡§æ' : '‡§π‡§™‡•ç‡§§‡§æ ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡§æ';
                messageDiv.style.display = 'block';
            }
        }

        function initialize() {
            document.getElementById('saleDate').valueAsDate = new Date();
            document.getElementById('paymentDate').valueAsDate = new Date();
            availableFlatsSelect.addEventListener('change', () => {
                const selectedFlat = availableFlatsData.find(f => f.flatId === availableFlatsSelect.value);
                basePriceInput.value = selectedFlat ? selectedFlat.price : '';
                finalRateInput.value = selectedFlat ? selectedFlat.price : '';
                updateTotalPrice();
            });
            [finalRateInput, ...expenseInputs].forEach(input => input.addEventListener('input', updateTotalPrice));
            
            // ‡§®‡§ø‡§µ‡§°‡§≤‡•á‡§≤‡•ç‡§Ø‡§æ ‡§´‡§æ‡§á‡§≤‡§ö‡•á ‡§®‡§æ‡§µ ‡§¶‡§æ‡§ñ‡§µ‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä
            screenshotFileInput.addEventListener('change', () => {
                fileNameDisplay.textContent = screenshotFileInput.files.length > 0 ? `‡§®‡§ø‡§µ‡§°‡§≤‡•á‡§≤‡•Ä ‡§´‡§æ‡§á‡§≤: ${screenshotFileInput.files[0].name}` : '';
            });

            newSaleForm.addEventListener('submit', (e) => handleFormSubmit(e, newSaleForm, document.getElementById('saleSubmitBtn'), document.getElementById('saleMessage')));
            installmentForm.addEventListener('submit', (e) => handleFormSubmit(e, installmentForm, document.getElementById('installmentSubmitBtn'), document.getElementById('installmentMessage')));
            
            fetchAndPopulateForms();
            updateTotalPrice();
        }

        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
