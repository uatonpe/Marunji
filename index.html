<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡§µ‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§°‡•á‡§ü‡§æ ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä ‡§´‡•â‡§∞‡•ç‡§Æ (Marunji Dashboard)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap');
        
        /* --- General Styles --- */
        :root {
            --primary-color: #007bff;
            --primary-dark: #0056b3;
            --success-bg: #d4edda;
            --success-text: #155724;
            --error-bg: #f8d7da;
            --error-text: #721c24;
            --light-gray: #f8f9fa;
            --border-color: #cdd3db;
        }

        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: #f0f4f8; 
            margin: 0; 
            padding: 20px; 
            box-sizing: border-box; 
        }

        /* --- Main Layout --- */
        main {
            display: grid;
            gap: 30px;
            width: 100%;
            max-width: 1200px; /* Max width for desktop */
            margin: 0 auto;
        }

        /* --- Responsive Grid Layout --- */
        @media (min-width: 992px) { /* Desktop View */
            main {
                grid-template-columns: 1fr 1fr; /* Two columns on desktop */
            }
        }
        @media (max-width: 991px) { /* Mobile and Tablet View */
            main {
                grid-template-columns: 1fr; /* Single column on smaller screens */
            }
        }

        /* --- Container/Card Styles --- */
        .container { 
            background-color: white; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 8px 24px rgba(0,37,86,0.1); 
        }

        h2 { 
            text-align: center; 
            color: #1a3b5d; 
            margin-top: 0; 
            margin-bottom: 25px; 
            border-bottom: 2px solid var(--primary-color); 
            padding-bottom: 10px; 
        }

        /* --- Form Elements --- */
        .form-group { margin-bottom: 15px; }
        
        label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 500; 
            color: #334e68; 
        }

        input, select { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            box-sizing: border-box; 
            font-size: 16px; 
            transition: border-color 0.3s, box-shadow 0.3s; 
        }

        input:focus, select:focus { 
            outline: none; 
            border-color: var(--primary-color); 
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1); 
        }

        input[readonly] { 
            background-color: #e9ecef; 
            cursor: not-allowed; 
        }
        
        .total-price { 
            font-size: 1.2em; 
            font-weight: 600; 
            color: #28a745; 
            text-align: right; 
            margin-top: 10px; 
            padding: 10px; 
            background-color: var(--light-gray); 
            border-radius: 8px; 
        }
        
        button { 
            width: 100%; 
            padding: 14px; 
            margin-top: 10px; 
            background: linear-gradient(90deg, var(--primary-color), var(--primary-dark)); 
            color: white; 
            border: none; 
            border-radius: 8px; 
            font-size: 18px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: transform 0.2s, background 0.3s; 
        }

        button:hover:not(:disabled) { transform: scale(1.02); }
        button:disabled { background: #a0aec0; cursor: not-allowed; }

        /* --- Feedback Messages --- */
        .message { 
            text-align: center; 
            margin-top: 20px; 
            font-weight: bold; 
            font-size: 16px; 
            white-space: pre-wrap; 
            padding: 15px; 
            border-radius: 8px; 
            display: none; 
        }
        .success { color: var(--success-text); background-color: var(--success-bg); border: 1px solid #c3e6cb; }
        .error { color: var(--error-text); background-color: var(--error-bg); border: 1px solid #f5c6cb; }
        
        hr {
            border: none;
            border-top: 1px solid #eee;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <main>
        <!-- ‡§®‡§µ‡•Ä‡§® ‡§µ‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§®‡•ã‡§Ç‡§¶‡§£‡•Ä ‡§´‡•â‡§∞‡•ç‡§Æ -->
        <div class="container">
            <h2>üè† ‡§®‡§µ‡•Ä‡§® ‡§µ‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§®‡•ã‡§Ç‡§¶‡§µ‡§æ</h2>
            <form id="newSaleForm">
                <input type="hidden" name="action" value="addNewSale">
                <!-- Flat Details -->
                <div class="form-group">
                    <label for="availableFlats">‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§´‡•ç‡§≤‡•Ö‡§ü:</label>
                    <select id="availableFlats" name="flatId" required>
                        <option value="">‡§≤‡•ã‡§° ‡§π‡•ã‡§§ ‡§Ü‡§π‡•á...</option>
                    </select>
                </div>
                <hr>
                <!-- Buyer and Agent Details -->
                <div class="form-group">
                    <label for="buyerName">‡§ñ‡§∞‡•á‡§¶‡•Ä‡§¶‡§æ‡§∞‡§æ‡§ö‡•á ‡§®‡§æ‡§µ:</label>
                    <input type="text" id="buyerName" name="buyerName" required>
                </div>
                <div class="form-group">
                    <label for="buyerContact">‡§ñ‡§∞‡•á‡§¶‡•Ä‡§¶‡§æ‡§∞‡§æ‡§ö‡§æ ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï:</label>
                    <input type="tel" id="buyerContact" name="buyerContact" required>
                </div>
                <div class="form-group">
                    <label for="agentName">‡§µ‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§ï‡§∞‡§£‡§æ‡§∞‡•á ‡§è‡§ú‡•á‡§Ç‡§ü‡§ö‡•á ‡§®‡§æ‡§Ç‡§µ:</label>
                    <input type="text" id="agentName" name="agentName" required>
                </div>
                <div class="form-group">
                    <label for="saleDate">‡§µ‡§ø‡§ï‡•ç‡§∞‡•Ä‡§ö‡•Ä ‡§§‡§æ‡§∞‡•Ä‡§ñ:</label>
                    <input type="date" id="saleDate" name="saleDate" required>
                </div>
                <hr>
                <!-- Pricing and Expenses -->
                <div class="form-group">
                    <label for="basePrice">‡§´‡•ç‡§≤‡•Ö‡§ü‡§ö‡•Ä ‡§Æ‡•Ç‡§≥ ‡§ï‡§ø‡§Ç‡§Æ‡§§ (‚Çπ):</label>
                    <input type="text" id="basePrice" name="basePrice" readonly>
                </div>
                <div class="form-group">
                    <label for="finalRate">‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§ï‡§ø‡§Ç‡§Æ‡§§ (Final Rate) (‚Çπ):</label>
                    <input type="number" id="finalRate" name="finalRate" min="1" required>
                </div>
                <div class="form-group">
                    <label for="registryExp">‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä ‡§ö‡§æ‡§∞‡•ç‡§ú‡•á‡§∏ (‚Çπ):</label>
                    <input type="number" class="expense" id="registryExp" name="registryExp" value="200000" min="0">
                </div>
                <div class="form-group">
                    <label for="stampDuty">‡§∏‡•ç‡§ü‡•Ö‡§Æ‡•ç‡§™ ‡§°‡•ç‡§Ø‡•Å‡§ü‡•Ä (8%) (‚Çπ):</label>
                    <input type="number" id="stampDuty" name="stampDuty" readonly>
                </div>
                <div class="form-group">
                    <label for="legalExp">‡§ï‡§æ‡§Ø‡§¶‡•á‡§∂‡•Ä‡§∞ ‡§ñ‡§∞‡•ç‡§ö (‚Çπ):</label>
                    <input type="number" class="expense" id="legalExp" name="legalExp" value="0" min="0">
                </div>
                <div class="form-group">
                    <label for="bankCharges">‡§¨‡§Å‡§ï ‡§ñ‡§∞‡•ç‡§ö (‚Çπ):</label>
                    <input type="number" class="expense" id="bankCharges" name="bankCharges" value="0" min="0">
                </div>
                 <div class="form-group">
                    <label for="otherExp">‡§á‡§§‡§∞ ‡§ñ‡§∞‡•ç‡§ö (‚Çπ):</label>
                    <input type="number" class="expense" id="otherExp" name="otherExp" value="0" min="0">
                </div>
                <div class="total-price" id="totalPriceDisplay">‡§è‡§ï‡•Ç‡§£ ‡§ï‡§ø‡§Ç‡§Æ‡§§: ‚Çπ0.00</div>
                <hr>
                <!-- Booking Amount -->
                <div class="form-group">
                    <label for="bookingAmount">‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§∞‡§ï‡•ç‡§ï‡§Æ (‚Çπ):</label>
                    <input type="number" id="bookingAmount" name="bookingAmount" min="1" required>
                </div>
                <input type="hidden" id="totalPrice" name="totalPrice">
                <button type="submit" id="saleSubmitBtn">‡§µ‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§®‡•ã‡§Ç‡§¶‡§µ‡§æ</button>
            </form>
            <div id="saleMessage" class="message"></div>
        </div>

        <!-- ‡§π‡§™‡•ç‡§§‡§æ ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡§£‡•ç‡§Ø‡§æ‡§ö‡§æ ‡§´‡•â‡§∞‡•ç‡§Æ -->
        <div class="container">
            <h2>üí∞ ‡§π‡§™‡•ç‡§§‡§æ ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡§æ</h2>
            <form id="installmentForm">
                <input type="hidden" name="action" value="addInstallment">
                <div class="form-group">
                   <label for="soldFlats">‡§µ‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§ù‡§æ‡§≤‡•á‡§≤‡•á ‡§´‡•ç‡§≤‡•Ö‡§ü:</label>
                   <select id="soldFlats" name="flatId" required>
                       <option value="">‡§≤‡•ã‡§° ‡§π‡•ã‡§§ ‡§Ü‡§π‡•á...</option>
                   </select>
               </div>
               <div class="form-group">
                   <label for="paymentDate">‡§™‡•á‡§Æ‡•á‡§Ç‡§ü‡§ö‡•Ä ‡§§‡§æ‡§∞‡•Ä‡§ñ:</label>
                   <input type="date" id="paymentDate" name="paymentDate" required>
               </div>
               <div class="form-group">
                   <label for="paymentAmount">‡§π‡§™‡•ç‡§§‡•ç‡§Ø‡§æ‡§ö‡•Ä ‡§∞‡§ï‡•ç‡§ï‡§Æ (‚Çπ):</label>
                   <input type="number" id="paymentAmount" name="paymentAmount" min="1" required>
               </div>
               <div class="form-group">
                   <label for="notes">‡§ü‡•Ä‡§™ (‡§ê‡§ö‡•ç‡§õ‡§ø‡§ï):</label>
                   <input type="text" id="notes" name="notes">
               </div>
               <button type="submit" id="installmentSubmitBtn">‡§π‡§™‡•ç‡§§‡§æ ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡§æ</button>
            </form>
            <div id="installmentMessage" class="message"></div>
        </div>
    </main>
    
    <!-- JavaScript Code (Single Script Tag) -->
    <script>
        // ‚ñº‚ñº‚ñº ‡§§‡•Å‡§Æ‡§ö‡§æ ‡§§‡•à‡§®‡§æ‡§§ ‡§ï‡•á‡§≤‡•á‡§≤‡§æ ‡§µ‡•á‡§¨ ‡•≤‡§™ URL ‡§á‡§•‡•á ‡§™‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡§æ ‚ñº‚ñº‚ñº
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwEHdicPbBtKh8YsZW2s5lVD19XutNdi7RFKfTuoC-fNeS93SOCq9pC6GKuMFbLLLI/exec'; // <-- ‡§§‡•Å‡§Æ‡§ö‡•Ä URL ‡§á‡§•‡•á ‡§ü‡§æ‡§ï‡§æ

        // --- Element Selectors ---
        const availableFlatsSelect = document.getElementById('availableFlats');
        const soldFlatsSelect = document.getElementById('soldFlats');
        const newSaleForm = document.getElementById('newSaleForm');
        const installmentForm = document.getElementById('installmentForm');
        const basePriceInput = document.getElementById('basePrice');
        const finalRateInput = document.getElementById('finalRate');
        const stampDutyInput = document.getElementById('stampDuty');
        const registryExpInput = document.getElementById('registryExp');
        const totalPriceDisplay = document.getElementById('totalPriceDisplay');
        const totalPriceHiddenInput = document.getElementById('totalPrice');
        const expenseInputs = document.querySelectorAll('.expense');
        
        let availableFlatsData = [];

        // --- Helper Functions ---
        const formatCurrency = (num) => `‚Çπ${Number(num).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

        function updateTotalPrice() {
            const finalRate = parseFloat(finalRateInput.value) || 0;
            
            // Calculate and set Stamp Duty (8% of final rate)
            const stampDutyValue = finalRate * 0.08;
            stampDutyInput.value = stampDutyValue.toFixed(2);

            // Get all other expenses
            const registryExp = parseFloat(registryExpInput.value) || 0;
            const legalExp = parseFloat(document.getElementById('legalExp').value) || 0;
            const bankCharges = parseFloat(document.getElementById('bankCharges').value) || 0;
            const otherExp = parseFloat(document.getElementById('otherExp').value) || 0;
            
            // Calculate total price including all expenses
            const total = finalRate + registryExp + stampDutyValue + legalExp + bankCharges + otherExp;
            
            totalPriceDisplay.textContent = `‡§è‡§ï‡•Ç‡§£ ‡§ï‡§ø‡§Ç‡§Æ‡§§: ${formatCurrency(total)}`;
            totalPriceHiddenInput.value = total;
        }
        
        // --- Data Fetching ---
        async function fetchAndPopulateForms() {
            try {
                const response = await fetch(WEB_APP_URL);
                if (!response.ok) throw new Error('Network response was not ok.');
                const data = await response.json();

                if (data.status === 'success') {
                    availableFlatsData = data.availableFlats;
                    availableFlatsSelect.innerHTML = '<option value="">-- ‡§´‡•ç‡§≤‡•Ö‡§ü ‡§®‡§ø‡§µ‡§°‡§æ --</option>';
                    availableFlatsData.forEach(flat => {
                        const option = new Option(`${flat.flatId} - (${formatCurrency(flat.price)})`, flat.flatId);
                        availableFlatsSelect.add(option);
                    });

                    soldFlatsSelect.innerHTML = '<option value="">-- ‡§´‡•ç‡§≤‡•Ö‡§ü ‡§®‡§ø‡§µ‡§°‡§æ --</option>';
                    data.soldFlats.forEach(flatInfo => {
                        const option = new Option(flatInfo, flatInfo);
                        soldFlatsSelect.add(option);
                    });
                } else { throw new Error(data.message); }
            } catch (error) {
                console.error("Error loading flats:", error);
                availableFlatsSelect.innerHTML = `<option value="">‡§è‡§∞‡§∞!</option>`;
                soldFlatsSelect.innerHTML = `<option value="">‡§è‡§∞‡§∞!</option>`;
            }
        }

        // --- Form Submission Logic ---
        async function handleFormSubmit(event, form, submitBtn, messageDiv) {
            event.preventDefault();
            submitBtn.disabled = true;
            submitBtn.textContent = '‡§™‡§æ‡§†‡§µ‡§§ ‡§Ü‡§π‡•á...';
            messageDiv.style.display = 'none';

            const formData = new FormData(form);

            try {
                const response = await fetch(WEB_APP_URL, { method: 'POST', body: formData });
                const resultText = await response.text();
                // Google Scripts sometimes returns HTML, so we check for a success keyword.
                 if (!response.ok || !resultText.includes('‡§Ø‡§∂‡§∏‡•ç‡§µ‡•Ä‡§∞‡§ø‡§§‡•ç‡§Ø‡§æ')) {
                    throw new Error(resultText);
                }

                messageDiv.textContent = resultText;
                messageDiv.className = 'message success';
                
                // Reset form with default values
                if (form.id === 'newSaleForm') {
                    form.reset();
                    registryExpInput.value = '200000'; // Restore default registry
                    basePriceInput.value = '';
                    finalRateInput.value = '';
                    updateTotalPrice();
                } else {
                     form.reset();
                }
                
                form.querySelector('input[type="date"]').valueAsDate = new Date();
                fetchAndPopulateForms();

            } catch (error) {
                messageDiv.textContent = error.message.replace(/<[^>]*>?/gm, '').replace('‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä: ', ''); // Clean HTML tags from error
                messageDiv.className = 'message error';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = form.id === 'newSaleForm' ? '‡§µ‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§®‡•ã‡§Ç‡§¶‡§µ‡§æ' : '‡§π‡§™‡•ç‡§§‡§æ ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡§æ';
                messageDiv.style.display = 'block';
            }
        }

        // --- Event Listeners and Initializer ---
        function initialize() {
            // Set default dates
            document.getElementById('saleDate').valueAsDate = new Date();
            document.getElementById('paymentDate').valueAsDate = new Date();

            // Attach event listeners
            availableFlatsSelect.addEventListener('change', () => {
                const selectedFlatId = availableFlatsSelect.value;
                const selectedFlat = availableFlatsData.find(f => f.flatId === selectedFlatId);
                if (selectedFlat) {
                    basePriceInput.value = selectedFlat.price;
                    finalRateInput.value = selectedFlat.price;
                } else {
                    basePriceInput.value = '';
                    finalRateInput.value = '';
                }
                updateTotalPrice(); // Calculate total price on flat selection
            });

            // Add event listeners to all manual expense fields and the final rate
            [finalRateInput, ...expenseInputs].forEach(input => {
                input.addEventListener('input', updateTotalPrice);
            });
            
            newSaleForm.addEventListener('submit', (e) => handleFormSubmit(e, newSaleForm, document.getElementById('saleSubmitBtn'), document.getElementById('saleMessage')));
            installmentForm.addEventListener('submit', (e) => handleFormSubmit(e, installmentForm, document.getElementById('installmentSubmitBtn'), document.getElementById('installmentMessage')));
            
            // Initial data load and total price calculation
            fetchAndPopulateForms();
            updateTotalPrice();
        }

        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
