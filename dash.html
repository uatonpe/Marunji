<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>रिअल इस्टेट विक्री डॅशबोर्ड</title>
    
    <!-- PapaParse for CSV parsing, Chart.js, and Font Awesome Icons from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        :root {
            --bg-color: #f0f2f5;
            --sidebar-bg: #ffffff;
            --card-bg: #ffffff;
            --primary-text: #1d2129;
            --secondary-text: #606770;
            --border-color: #e4e6eb;
            --shadow: 0 1px 2px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.1);
            --primary-color: #1877f2;
            --green: #42b72a;
            --orange: #f7b924;
            --red: #fa383e;
            --font-family: 'Poppins', sans-serif;
        }

        body {
            margin: 0;
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--primary-text);
            overflow-x: hidden;
        }

        .dashboard-container {
            display: grid;
            grid-template-columns: 1fr;
            grid-template-rows: auto 1fr;
            grid-template-areas: "header" "main";
            min-height: 100vh;
        }
        
        @media (min-width: 1200px) {
            .dashboard-container {
                grid-template-columns: 260px 1fr;
                grid-template-areas: "header header" "sidebar main";
            }
        }
        
        .header {
            grid-area: header;
            background-color: var(--card-bg);
            padding: 0 2rem;
            height: 70px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            z-index: 100;
        }

        .header h1 {
            font-size: 1.6rem;
            font-weight: 600;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sidebar {
            grid-area: sidebar;
            background-color: var(--sidebar-bg);
            padding: 1.5rem;
            border-right: 1px solid var(--border-color);
        }
        
        @media (max-width: 1199px) {
            .sidebar { display: none; }
        }

        .main-content {
            grid-area: main;
            padding: 2rem;
            overflow-y: auto;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .kpi-card {
            background: var(--card-bg);
            padding: 1.25rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border-left: 5px solid transparent;
        }
        
        .kpi-card:hover, .kpi-card.active {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1), 0 8px 16px rgba(0,0,0,0.1);
        }
        
        .kpi-card .icon { font-size: 2.2rem; }
        .kpi-card .info .value { font-size: 1.8rem; font-weight: 700; }
        .kpi-card .info .label { font-size: 0.85rem; color: var(--secondary-text); }

        .kpi-total { border-color: var(--primary-color); color: var(--primary-color); }
        .kpi-sold { border-color: var(--green); color: var(--green); }
        .kpi-available { border-color: var(--orange); color: var(--orange); }
        .kpi-collected { border-color: var(--green); color: var(--green); }
        .kpi-pending { border-color: var(--red); color: var(--red); }
        
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        @media (min-width: 992px) {
            .charts-grid { grid-template-columns: 1fr 1fr; }
        }
        @media (min-width: 1400px) {
            .charts-grid { grid-template-columns: 2fr 1fr 1fr; }
        }

        .chart-container {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
            height: 400px;
            display: flex;
            flex-direction: column;
        }
        .chart-container h3 { 
            margin-top: 0;
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
            font-weight: 600;
        }
        .chart-wrapper {
            position: relative;
            flex-grow: 1;
        }
        
        .full-width { grid-column: 1 / -1; }

        .table-container {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .table-controls h3 { margin: 0; }
        
        .table-controls input {
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            width: 100%;
            max-width: 300px;
            font-size: 1rem;
        }

        .table-wrapper { overflow-x: auto; }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th, td {
            padding: 0.8rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        thead th {
            background-color: #f7f7f7;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            position: sticky;
            top: 0;
        }
        
        .sort-indicator { display: inline-block; margin-left: 5px; opacity: 0.6; }

        tbody tr:hover { background-color: #f5f5f5; }
        
        .status-badge {
            padding: 0.25rem 0.6rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
            display: inline-block;
        }
        .status-विक्री-झाली { background-color: var(--green); }
        .status-उपलब्ध { background-color: var(--orange); }

        .loading-overlay {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex; justify-content: center; align-items: center;
            z-index: 1001; font-size: 1.5rem;
            font-weight: 500;
            flex-direction: column;
            gap: 1rem;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="dashboard-container">
        <header class="header">
            <h1><i class="fa-solid fa-chart-line"></i> विक्री डॅशबोर्ड</h1>
        </header>

        <aside class="sidebar">
        </aside>

        <main class="main-content">
            <div id="loading" class="loading-overlay">
                <div class="loader"></div>
                <span>डेटा लोड होत आहे...</span>
            </div>
            
            <section class="kpi-grid">
                <div class="kpi-card kpi-total active" data-filter="all">
                    <div class="icon"><i class="fa-solid fa-building"></i></div>
                    <div class="info">
                        <div class="value" id="kpi-total-flats">0</div>
                        <div class="label">एकूण फ्लॅट्स</div>
                    </div>
                </div>
                <div class="kpi-card kpi-sold" data-filter="sold">
                    <div class="icon"><i class="fa-solid fa-house-circle-check"></i></div>
                    <div class="info">
                        <div class="value" id="kpi-sold-flats">0</div>
                        <div class="label">विक्री झाली</div>
                    </div>
                </div>
                <div class="kpi-card kpi-available" data-filter="available">
                    <div class="icon"><i class="fa-solid fa-house-circle-xmark"></i></div>
                    <div class="info">
                        <div class="value" id="kpi-available-flats">0</div>
                        <div class="label">उपलब्ध फ्लॅट्स</div>
                    </div>
                </div>
                <div class="kpi-card kpi-collected" data-filter="collected-positive">
                    <div class="icon"><i class="fa-solid fa-indian-rupee-sign"></i></div>
                    <div class="info">
                        <div class="value" id="kpi-total-collected">₹0</div>
                        <div class="label">एकूण जमा रक्कम</div>
                    </div>
                </div>
                <div class="kpi-card kpi-pending" data-filter="pending-positive">
                     <div class="icon"><i class="fa-solid fa-hourglass-half"></i></div>
                    <div class="info">
                        <div class="value" id="kpi-total-pending">₹0</div>
                        <div class="label">एकूण शिल्लक रक्कम</div>
                    </div>
                </div>
            </section>

            <section class="charts-grid">
                <div class="chart-container full-width">
                    <h3>वेळेनुसार जमा रक्कम (मासिक)</h3>
                    <div class="chart-wrapper"><canvas id="collections-chart"></canvas></div>
                </div>
                <div class="chart-container">
                    <h3>फ्लॅट स्थिती</h3>
                    <div class="chart-wrapper"><canvas id="status-chart"></canvas></div>
                </div>
                <div class="chart-container">
                    <h3>टॉप ५ शिल्लक रक्कम</h3>
                    <div class="chart-wrapper"><canvas id="balance-chart"></canvas></div>
                </div>
            </section>

            <section class="table-container">
                <div class="table-controls">
                    <h3>सर्व फ्लॅट्सची माहिती</h3>
                    <input type="text" id="table-search" placeholder="फ्लॅट आयडी, खरेदीदार, स्थितीनुसार शोधा...">
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead id="table-head"></thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <script>
        // ▼▼▼ तुमच्या Publish केलेल्या Sheet च्या CSV लिंक इथे पेस्ट करा ▼▼▼
        const FLATS_CSV_URL = 'YOUR_FLATS_CSV_URL_HERE';
        const PAYMENTS_CSV_URL = 'YOUR_PAYMENTS_CSV_URL_HERE';
        // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

        document.addEventListener('DOMContentLoaded', () => {

            // --- Global State ---
            let allFlatsData = [];
            let chartInstances = {};
            let currentSort = { key: 'फ्लॅट आयडी', asc: true };
            let currentFilter = 'all';

            // --- UI Elements ---
            const loadingOverlay = document.getElementById('loading');
            const kpiCards = document.querySelectorAll('.kpi-card');
            const tableSearchInput = document.getElementById('table-search');
            const tableHead = document.getElementById('table-head');
            const tableBody = document.getElementById('table-body');

            // --- Helper Functions ---
            const formatCurrency = (num) => `₹${Number(num).toLocaleString('en-IN')}`;
            const showLoading = (show) => { loadingOverlay.style.display = show ? 'flex' : 'none'; };

            // --- Data Fetching and Processing ---
            async function fetchData(url) {
                return new Promise((resolve, reject) => {
                    Papa.parse(url, {
                        download: true,
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => resolve(results.data),
                        error: (error) => reject(error),
                    });
                });
            }
            
            async function fetchAndProcessData() {
                showLoading(true);
                try {
                    // दोन्ही शीटचा डेटा एकाच वेळी मिळवा
                    const [flats, payments] = await Promise.all([
                        fetchData(FLATS_CSV_URL),
                        fetchData(PAYMENTS_CSV_URL)
                    ]);

                    // डेटा एकत्र करून डॅशबोर्डसाठी तयार करा
                    allFlatsData = flats.map(flat => {
                        const flatPayments = payments.filter(p => p['फ्लॅट आयडी'] === flat['फ्लॅट आयडी']);
                        const totalPaid = flatPayments.reduce((sum, p) => sum + Number(p['रक्कम']), 0);
                        
                        // अंतिम किंमत किंवा मूळ किंमत वापरा
                        const finalPrice = Number(flat['अंतिम किंमत']) || Number(flat['किंमत']);
                        const remainingBalance = finalPrice - totalPaid;

                        return {
                            ...flat,
                            'अंतिम किंमत': finalPrice,
                            'एकूण भरलेली रक्कम': totalPaid,
                            'शिल्लक रक्कम': remainingBalance,
                            'पेमेंट्स': flatPayments
                        };
                    });
                    
                    renderDashboard();

                } catch (error) {
                    console.error('डेटा मिळवताना त्रुटी:', error);
                    loadingOverlay.innerHTML = `<span>त्रुटी: ${error.message}</span>`;
                } finally {
                    setTimeout(() => showLoading(false), 500);
                }
            }
            
            // --- Rendering Functions ---
            function renderDashboard() {
                renderKPIs(allFlatsData);
                renderCharts(allFlatsData);
                renderTable(allFlatsData); 
            }

            function renderKPIs(data) {
                const totalFlats = data.length;
                const soldFlats = data.filter(f => f['स्थिती'] === 'विक्री झाली');
                const availableFlats = totalFlats - soldFlats.length;
                const totalCollected = soldFlats.reduce((sum, f) => sum + f['एकूण भरलेली रक्कम'], 0);
                const totalPending = soldFlats.reduce((sum, f) => sum + f['शिल्लक रक्कम'], 0);

                document.getElementById('kpi-total-flats').textContent = totalFlats;
                document.getElementById('kpi-sold-flats').textContent = soldFlats.length;
                document.getElementById('kpi-available-flats').textContent = availableFlats;
                document.getElementById('kpi-total-collected').textContent = formatCurrency(totalCollected);
                document.getElementById('kpi-total-pending').textContent = formatCurrency(totalPending);
            }

            function renderCharts(data) {
                Object.values(chartInstances).forEach(chart => chart.destroy());
                const soldFlats = data.filter(f => f['स्थिती'] === 'विक्री झाली');

                const paymentsByMonth = soldFlats.flatMap(f => f['पेमेंट्स']).reduce((acc, p) => {
                    if (!p['तारीख']) return acc;
                    const month = p['तारीख'].substring(0, 7); // YYYY-MM
                    acc[month] = (acc[month] || 0) + Number(p['रक्कम']);
                    return acc;
                }, {});
                const sortedMonths = Object.keys(paymentsByMonth).sort();
                
                chartInstances.collections = new Chart('collections-chart', {
                    type: 'line', data: { labels: sortedMonths, datasets: [{ label: 'मासिक जमा रक्कम', data: sortedMonths.map(m => paymentsByMonth[m]), borderColor: 'var(--primary-color)', backgroundColor: 'rgba(24, 119, 242, 0.1)', fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false }
                });

                const statusCounts = data.reduce((acc, f) => { acc[f['स्थिती']] = (acc[f['स्थिती']] || 0) + 1; return acc; }, {});
                chartInstances.status = new Chart('status-chart', {
                    type: 'doughnut', data: { labels: ['विक्री झाली', 'उपलब्ध'], datasets: [{ data: [statusCounts['विक्री झाली'] || 0, statusCounts['उपलब्ध'] || 0], backgroundColor: ['var(--green)', 'var(--orange)'] }] }, options: { responsive: true, maintainAspectRatio: false }
                });

                const top5Pending = soldFlats.filter(f => f['शिल्लक रक्कम'] > 0).sort((a, b) => b['शिल्लक रक्कम'] - a['शिल्लक रक्कम']).slice(0, 5);
                chartInstances.balance = new Chart('balance-chart', {
                    type: 'bar', data: { labels: top5Pending.map(f => f['फ्लॅट आयडी']), datasets: [{ label: 'शिल्लक रक्कम', data: top5Pending.map(f => f['शिल्लक रक्कम']), backgroundColor: 'rgba(250, 56, 62, 0.7)' }] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y' }
                });
            }

            function renderTable(data) {
                const headers = ['फ्लॅट आयडी', 'स्थिती', 'खरेदीदाराचे नाव', 'अंतिम किंमत', 'एकूण भरलेली रक्कम', 'शिल्लक रक्कम'];
                if (tableHead.innerHTML === '') {
                    tableHead.innerHTML = `<tr>${headers.map(h => `<th data-key="${h}">${h} <span class="sort-indicator"></span></th>`).join('')}</tr>`;
                }

                let filteredData = data;
                if (currentFilter !== 'all') {
                    if (currentFilter === 'sold') filteredData = data.filter(f => f['स्थिती'] === 'विक्री झाली');
                    else if (currentFilter === 'available') filteredData = data.filter(f => f['स्थिती'] === 'उपलब्ध');
                    else if (currentFilter === 'collected-positive') filteredData = data.filter(f => f['एकूण भरलेली रक्कम'] > 0);
                    else if (currentFilter === 'pending-positive') filteredData = data.filter(f => f['शिल्लक रक्कम'] > 0);
                }
                
                const searchTerm = tableSearchInput.value.toLowerCase();
                if (searchTerm) {
                    filteredData = filteredData.filter(flat => 
                        flat['फ्लॅट आयडी'].toLowerCase().includes(searchTerm) ||
                        String(flat['खरेदीदाराचे नाव']).toLowerCase().includes(searchTerm) ||
                        flat['स्थिती'].toLowerCase().includes(searchTerm)
                    );
                }

                const sortedData = [...filteredData].sort((a, b) => {
                    const valA = a[currentSort.key]; const valB = b[currentSort.key];
                    const numA = parseFloat(String(valA).replace(/[₹,]/g, ''));
                    const numB = parseFloat(String(valB).replace(/[₹,]/g, ''));
                    if (!isNaN(numA) && !isNaN(numB)) { return currentSort.asc ? numA - numB : numB - numA; }
                    if (valA < valB) return currentSort.asc ? -1 : 1;
                    if (valA > valB) return currentSort.asc ? 1 : -1;
                    return 0;
                });
                
                tableBody.innerHTML = sortedData.map(flat => `
                    <tr>
                        <td><strong>${flat['फ्लॅट आयडी']}</strong></td>
                        <td><span class="status-badge status-${flat['स्थिती'].replace(/\s+/g, '-')}">${flat['स्थिती']}</span></td>
                        <td>${flat['खरेदीदाराचे नाव'] || '-'}</td>
                        <td>${formatCurrency(flat['अंतिम किंमत'])}</td>
                        <td>${formatCurrency(flat['एकूण भरलेली रक्कम'])}</td>
                        <td>${formatCurrency(flat['शिल्लक रक्कम'])}</td>
                    </tr>
                `).join('');
            }

            // --- Event Listeners ---
            kpiCards.forEach(card => card.addEventListener('click', () => {
                kpiCards.forEach(c => c.classList.remove('active'));
                card.classList.add('active');
                currentFilter = card.dataset.filter;
                renderTable(allFlatsData);
            }));
            tableSearchInput.addEventListener('input', () => renderTable(allFlatsData));
            tableHead.addEventListener('click', e => {
                const key = e.target.closest('th')?.dataset.key;
                if (!key) return;
                currentSort.asc = currentSort.key === key ? !currentSort.asc : true;
                currentSort.key = key;
                document.querySelectorAll('#table-head th .sort-indicator').forEach(span => span.textContent = '');
                e.target.closest('th').querySelector('.sort-indicator').textContent = currentSort.asc ? '▲' : '▼';
                renderTable(allFlatsData);
            });

            // --- Initializer ---
            function init() {
                if (FLATS_CSV_URL === 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSpEep4T1FNEoRc5CfDx6F9hh7sN7IvlH2Vgb9NndWEqWrqt0i_ZlE4-a9h5SXNwSezT6JoVWyKguYo/pub?gid=0&single=true&output=csv' || PAYMENTS_CSV_URL === 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSpEep4T1FNEoRc5CfDx6F9hh7sN7IvlH2Vgb9NndWEqWrqt0i_ZlE4-a9h5SXNwSezT6JoVWyKguYo/pub?gid=1815984816&single=true&output=csv') {
                    loadingOverlay.innerHTML = '<span>त्रुटी: कृपया Published CSV URLs सेट करा.</span>';
                    return;
                }
                fetchAndProcessData();
            }
            init();
        });
    </script>
</body>

</html>
